From 68f9ff07f2da958200caa66145b8bc8ccb4a6726 Mon Sep 17 00:00:00 2001
From: muyangren907 <907097904@qq.com>
Date: Sun, 9 Oct 2022 13:00:49 +0000
Subject: [PATCH] add douyinzhibo46sby

---
 docker/douyinMulLiveAioHeroku.py | 52 +++++++++++++++++++++++++++-----
 1 file changed, 45 insertions(+), 7 deletions(-)

diff --git a/docker/douyinMulLiveAioHeroku.py b/docker/douyinMulLiveAioHeroku.py
index 038cbd7..432a688 100644
--- a/docker/douyinMulLiveAioHeroku.py
+++ b/docker/douyinMulLiveAioHeroku.py
@@ -44,6 +44,11 @@ def base64decode(a):
     de = base64.b64decode(a)
     return de.decode('utf-8')
 
+from urllib.parse import unquote
+def urldecode(strin):
+    text = unquote(strin, 'utf-8')
+    return text
+
 import logging  # 引入logging模块
 
 
@@ -149,11 +154,15 @@ async def get(session,queue):
         # 'upgrade-insecure-requests':'1',
         # 'X-Forwarded-For': genip(),
         # 'User-Agent': 'Mozilla/5.0 (Linux; Android 8.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Mobile Safari/537.36'
-        'User-Agent':'Mozilla/5.0 (Linux; U; Android 8.1.0; en-US; Nexus 6P Build/OPM7.181205.001) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/57.0.2987.108 UCBrowser/12.11.1.1197 Mobile Safari/537.36'
+        # 'User-Agent':'Mozilla/5.0 (Linux; U; Android 8.1.0; en-US; Nexus 6P Build/OPM7.181205.001) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/57.0.2987.108 UCBrowser/12.11.1.1197 Mobile Safari/537.36'
+        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36 Edg/106.0.1370.34',
+
     }
     js_headers = {
         # 'upgrade-insecure-requests':'1',
-        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Mobile Safari/537.36'
+        # 'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Mobile Safari/537.36'
+        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36 Edg/106.0.1370.34',
+
     }
     while True:
         try:
@@ -169,16 +178,43 @@ async def get(session,queue):
             try:
                 try_time += 1
                 res = await session.get(share_url, headers=Modelheaders, timeout=10)
-                # logger.info(res.url)
                 resurl = str(res.url)
                 roomid = ((resurl).split('/')[-1]).split('?')[0]
-                # print(''.format(roomid))
-                jsurl = "https://webcast.amemv.com/webcast/room/reflow/info/?type_id=0&live_id=1&room_id=" + roomid + "&app_id=1128"
+                # print(resurl)
+                # print('{}'.format(roomid))
+                # print('{}'.format(res.history))
+
+                res_html = await res.text()
+                logger.info(share_url)
+                # exit(0)
+                # spos_str = 'type="application/json">%7B%22'
+                # epos_str = '</script>'
+                # spos_idx = res_html.index(spos_str)+len('type="application/json">')
+                # epos_idx = res_html[spos_idx:].index(epos_str)
+                # res_json_ec = res_html[spos_idx:spos_idx+epos_idx]
+                # res_json_str = urldecode(res_json_ec)
+                # res_json = json.loads(res_json_str)
+                # logger.info(res_json_str)
+                # time.sleep(90)
+
+
+
+                logger.info(res.url)
+                resurl = str(res.url)
+                roomid = ((resurl).split('/')[-1]).split('?')[0]
+                # print('{}'.format(roomid))
+                
+                jsurl = "https://webcast.amemv.com/webcast/room/reflow/info/?type_id=0&live_id=1&room_id=" + roomid + "&app_id=1128&verifyFp=verify_l7rjcs0w_v8JHPZG6_dMDh_4DdV_8Tah_ulpH9Cc9ljkq&sec_user_id=&msToken=EAgLgmWAd9KyOEnKwVwEn1q9nLpgepI9PcP8If7OpX0ApspZ3cVxwh3AopWkX8sbeT9YoIsD3F5zjo12ClWKxQ5UTPfmwdIa0xrKH8X2nh_M9lHlOa0dfPgOS8AOaA==&X-Bogus=DFSzswVO61iANaewSM5chl9WX7ra"
+                logger.info(jsurl)
+                
                 res_js = await session.get(jsurl, headers=Modelheaders, timeout=10)
                 res_html = await res_js.text()
                 res_html = str(res_html)
-                # print(res_html)
+                # print('{}'.format(res_html))
                 res_html = json.loads(res_html)
+                # exit(0)
+                
+
                 if res_html != '':
                     break
                 else:
@@ -214,7 +250,7 @@ async def get(session,queue):
         # res_status = await get_status(res_html)
         # res_urls = await get_urls(res_html)
         # room_url = 'https://webcast.amemv.com/webcast/reflow/{}'.format(res_roomid)
-        room_url = "https://webcast.amemv.com/webcast/room/reflow/info/?type_id=0&live_id=1&room_id={}&app_id=1128".format(res_roomid)
+        room_url = "https://webcast.amemv.com/webcast/room/reflow/info/?type_id=0&live_id=1&room_id={}&app_id=1128&verifyFp=verify_l7rjcs0w_v8JHPZG6_dMDh_4DdV_8Tah_ulpH9Cc9ljkq&sec_user_id=&msToken=EAgLgmWAd9KyOEnKwVwEn1q9nLpgepI9PcP8If7OpX0ApspZ3cVxwh3AopWkX8sbeT9YoIsD3F5zjo12ClWKxQ5UTPfmwdIa0xrKH8X2nh_M9lHlOa0dfPgOS8AOaA==&X-Bogus=DFSzswVO61iANaewSM5chl9WX7ra".format(res_roomid)
         # res = await session.get(room_url, headers=Modelheaders, proxy=proxies2, timeout=30)
         # res_html = await res.text()
 
@@ -228,7 +264,9 @@ async def get(session,queue):
                 res_html = await res.text()
                 # res_html = await res_js.text()
                 res_html = str(res_html)
+                # exit(0)
                 # print(res_html)
+                logger.info("{}".format(room_url))
                 res_html = json.loads(res_html)
                 if res_html != '':
                     break
-- 
2.30.2

